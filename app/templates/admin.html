<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>管理画面｜ログ削除＆閲覧</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    body {
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
      padding-top: 70px;
    }

    .help-text {
      font-size: .9rem;
      color: var(--bs-secondary-color);
    }

    .chart-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .chart-box {
      flex: 1 1 45%;
      min-width: 350px;
      height: 280px;
    }

    .table-container {
      max-height: 60vh;
      overflow-y: auto;
    }

    .table-container thead th {
      position: sticky;
      top: 0;
      background-color: var(--bs-dark, #343a40);
      /* Bootstrapのダーク色 or フォールバック */
      color: white;
      z-index: 2;
      /* ヘッダーが下の行より前面にくるように */
    }

    th,
    td {
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <!-- ヘッダー ナビバー -->
  {% include 'partials/_header.html' %}

  <div class="container py-4">
    <h1 class="mb-4">🛠 管理画面（表示・選択削除・範囲削除）</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- コントロール -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">対象CSVファイル</label>
            <select id="filename" class="form-select" required>
              <option value="" disabled selected>選択してください</option>
              {% for f in files %}
              <option value="{{ f }}">{{ f }}</option>
              {% endfor %}
            </select>
            <div class="help-text">/log/ 配下のCSVのみが対象です。</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">開始時刻（含む）</label>
            <input type="datetime-local" id="start" class="form-control">
            <div class="form-text">ファイル選択時に自動入力（最小時刻）。</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">終了時刻（含む）</label>
            <input type="datetime-local" id="end" class="form-control">
            <div class="form-text">ファイル選択時に自動入力（最大時刻）。</div>
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button id="btn-range-delete" class="btn btn-danger" disabled>🧹 範囲で削除</button>
          <button id="btn-selected-delete" class="btn btn-warning" disabled>🗑 選択行を削除</button>
          <button id="btn-reload" class="btn btn-outline-secondary" disabled>🔄 再読み込み</button>
        </div>
      </div>
    </div>

    <!-- 統計 -->
    <div id="stats" class="mb-3 text-muted"></div>

    <!-- グラフ -->
    <div id="charts" class="chart-container mb-4"></div>

    <!-- テーブル -->
    <div class="table-responsive table-container">
      <table id="log-table" class="table table-bordered table-striped table-sm align-middle">
        <thead class="table-dark" id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    let header = [];
    let rows = [];    // array of arrays (without header)
    let filename = null;
    let minTs = null;
    let maxTs = null;

    const sensorColors = {
      Temp: "#e74c3c",
      Hum: "#3498db",
      Pres: "#7f8c8d",
      Light: "#f1c40f",
      Soil: "#27ae60",
      Bus: "#9b59b6",
      Current: "#e67e22",
      Power: "#8e6e53"
    };

    function fmtCount(n) { return n.toLocaleString(); }

    function setButtonsEnabled(en) {
      document.getElementById("btn-range-delete").disabled = !en;
      document.getElementById("btn-selected-delete").disabled = !en;
      document.getElementById("btn-reload").disabled = !en;
    }

    async function fetchData() {
      if (!filename) return;
      setButtonsEnabled(false);
      const r = await fetch(`/admin/data?filename=${encodeURIComponent(filename)}`);
      if (!r.ok) { alert("データ取得に失敗しました"); return; }
      const data = await r.json();
      header = data.header || [];
      rows = data.rows || [];
      minTs = data.min_ts || null;
      maxTs = data.max_ts || null;

      // 日付入力を自動セット＋範囲制限
      if (minTs && maxTs) {
        const start = document.getElementById("start");
        const end = document.getElementById("end");
        start.value = minTs.slice(0, 16);  // YYYY-MM-DDTHH:MM
        end.value = maxTs.slice(0, 16);
        start.min = minTs.slice(0, 16);
        start.max = maxTs.slice(0, 16);
        end.min = minTs.slice(0, 16);
        end.max = maxTs.slice(0, 16);
      }

      // 統計
      const statEl = document.getElementById("stats");
      statEl.textContent = `行数: ${fmtCount(rows.length)}　範囲: ${minTs ?? "-"} 〜 ${maxTs ?? "-"}`;

      renderCharts();
      renderTable();
      setButtonsEnabled(true);
    }

    function renderCharts() {
      const chartsDiv = document.getElementById("charts");
      chartsDiv.innerHTML = "";
      if (header.length === 0 || rows.length === 0) return;

      const sensors = header.slice(1);
      const labels = rows.map(r => r[0]);

      sensors.forEach((key, idx) => {
        const y = rows.map(r => parseFloat(r[idx + 1])).filter(v => !isNaN(v));
        const chartId = `chart-${key}`;
        const box = document.createElement("div");
        box.className = "chart-box";
        box.id = chartId;
        chartsDiv.appendChild(box);
        Plotly.newPlot(chartId, [{
          x: labels,
          y: rows.map(r => parseFloat(r[idx + 1])),
          mode: "lines+markers",
          name: key,
          line: { color: sensorColors[key] || "gray", shape: "spline" },
          marker: { size: 4 }
        }], {
          title: key,
          margin: { t: 30, l: 50, r: 10, b: 40 },
          xaxis: { title: "時刻", tickangle: -45 },
          yaxis: { title: key },
          height: 250
        }, { responsive: true });
      });
    }

    function renderTable() {
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      if (header.length === 0) return;

      const tr = document.createElement("tr");
      tr.innerHTML = `<th style="width:40px;"><input type="checkbox" id="chk-all"></th>` + header.map(h => `<th>${h}</th>`).join("");
      thead.appendChild(tr);

      rows.forEach((r, idx) => {
        const trb = document.createElement("tr");
        trb.innerHTML = `<td><input type="checkbox" class="chk" data-index="${idx}"></td>` + r.map(c => `<td>${c}</td>`).join("");
        tbody.appendChild(trb);
      });

      const chkAll = document.getElementById("chk-all");
      chkAll.addEventListener("change", function () {
        document.querySelectorAll(".chk").forEach(cb => cb.checked = chkAll.checked);
      });
    }

    async function deleteSelected() {
      const checked = Array.from(document.querySelectorAll(".chk:checked"));
      if (checked.length === 0) { alert("削除する行を選択してください。"); return; }
      if (!confirm(`${checked.length} 行を削除します。よろしいですか？`)) return;
      const indices = checked.map(cb => parseInt(cb.dataset.index, 10));
      const r = await fetch("/admin/delete-rows", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename, indices })
      });
      if (!r.ok) { alert("削除に失敗しました"); return; }
      await fetchData();
    }

    async function deleteByRange() {
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      if (!start || !end) { alert("開始と終了を入力してください"); return; }
      if (start > end) { alert("終了は開始以降にしてください"); return; }
      if (!confirm(`範囲 ${start} 〜 ${end} に含まれる行を削除します。よろしいですか？`)) return;

      const form = new FormData();
      form.append("filename", filename);
      form.append("start", start);
      form.append("end", end);
      form.append("backup", "1");

      const r = await fetch("/admin/delete", { method: "POST", body: form });
      if (!r.redirected && !r.ok) {
        alert("範囲削除に失敗しました");
      }
      await fetchData();
    }

    document.getElementById("filename").addEventListener("change", (e) => {
      filename = e.target.value;
      fetchData();
    });

    document.getElementById("btn-selected-delete").addEventListener("click", deleteSelected);
    document.getElementById("btn-range-delete").addEventListener("click", deleteByRange);
    document.getElementById("btn-reload").addEventListener("click", fetchData);
  </script>
</body>

</html>