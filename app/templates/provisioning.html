<!-- templates/provisioning.html -->
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° | æ¤ç‰©ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      padding-top: 70px;
    }

    .table thead th {
      white-space: nowrap;
    }

    .form-check-input {
      transform: scale(1.05);
    }

    .readonly {
      background-color: var(--bs-tertiary-bg);
    }

    .w-ctl {
      width: 120px;
    }

    .w-key {
      width: 180px;
    }
  </style>
</head>

<body>
  {% include 'partials/_header.html' %}
  <div class="container">
    <div class="d-flex align-items-center mb-3">
      <h1 class="me-3 mb-0">ğŸ›  ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°</h1>
      <span class="text-muted">æœ€çµ‚å—ä¿¡ï¼š{{ device.last_report_time or "-" }}</span>
    </div>

    <!-- ãƒ‡ãƒã‚¤ã‚¹é¸æŠ -->
    <div class="card mb-3">
      <div class="card-body">
        <form class="row gy-2 gx-2 align-items-center" method="get" action="/provisioning">
          <div class="col-auto"><label class="col-form-label">å¯¾è±¡ãƒ‡ãƒã‚¤ã‚¹ï¼ˆæœ€æ–°é †ï¼‰</label></div>
          <div class="col-auto">
            <select class="form-select" name="mac" onchange="this.form.submit()">
              {% set current_mac = device.mac or '-' %}
              <option value="">ï¼ˆæœ€æ–°ã‚’è‡ªå‹•é¸æŠï¼‰</option>
              {% for d in devices %}
              {% set mac_str = d.mac or '-' %}
              <option value="{{ mac_str }}" {% if mac_str==current_mac %}selected{% endif %}>
                {{ mac_str }}ï¼ˆæœ€çµ‚: {{ d.last_report_time or '-' }}ï¼‰
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto text-muted">
            SoftAPï¼š<code>{{ device.ap_ssid or '-' }}</code> / IPï¼š<code>{{ device.ap_ip or '-' }}</code>
          </div>
        </form>
      </div>
    </div>

    <!-- å³ã«ã—ã‹ãªã„é …ç›®ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä¸‹ã«è¨˜è¼‰ï¼‰ -->
    <hr class="my-4">
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <label class="form-label">MAC/IPï¼ˆè­˜åˆ¥ï¼‰</label>
        <input class="form-control readonly" type="text" value="{{ device.mac or '-' }}" readonly>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">å—ä¿¡æ™‚åˆ»</label>
        <input class="form-control readonly" type="text" value="{{ device.last_report_time or '-' }}" readonly>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">ap_ssid</label>
        <input class="form-control readonly" type="text" value="{{ device.ap_ssid or '-' }}" readonly>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">ap_ip</label>
        <input class="form-control readonly" type="text" value="{{ device.ap_ip or '-' }}" readonly>
      </div>
    </div>
    <hr class="my-4">

    <!-- æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå·¦ï¼ä¿å­˜ã™ã‚‹å€¤å…¥åŠ›ï¼å³ï¼å—ä¿¡å€¤readonlyï¼‰ -->
    <div class="card shadow-sm">
      <div class="card-header">
        <strong>è¨­å®šå€¤ï¼å—ä¿¡å€¤</strong>
      </div>
      <div class="card-body">
        <form method="post" action="/provisioning/save-selected">
          <!-- é€ä¿¡å…ˆ ap_ip è¡¨ç¤ºï¼ˆä¿å­˜ã«ã¯ä½¿ã‚ãªã„ãŒå‚ç…§ã®ãŸã‚æ®‹ã™ï¼‰ -->
          <input type="hidden" name="ap_ip" value="{{ device.ap_ip or '' }}" readonly>

          {% set rows = [
          ("ssid", "WiFi SSID", desired.get("ssid",""), device.ssid or "-"),
          ("pass", "WiFi PASS", desired.get("pass",""), device.pass if device.pass is defined else "-"),
          ("uaddr", "UDP Addr", desired.get("uaddr",""), device.uaddr or "-"),
          ("uport", "UDP Port", desired.get("uport",""), device.uport or "-"),
          ("soil", "Soil", desired.get("soil",""), device.soil or "-"),
          ("pump_ms", "Pump ms", desired.get("pump_ms",""),device.pump_ms or "-"),
          ("init_ms", "Init ms", desired.get("init_ms",""),device.init_ms or "-"),
          ("dsw_ms", "DS Wait ms", desired.get("dsw_ms",""), device.dsw_ms or "-"),
          ("sleep_s", "Sleep s", desired.get("sleep_s",""),device.sleep_s or "-"),
          ] %}

          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th class="w-ctl">ä¿å­˜</th>
                  <th class="w-key">ã‚­ãƒ¼</th>
                  <th>è¨­å®šå€¤</th>
                  <th>å—ä¿¡å€¤</th>
                </tr>
              </thead>
              <tbody>
                {% for key, label, leftVal, rightVal in rows %}
                <tr>
                  <td>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="send_{{ key }}" id="send_{{ key }}"
                        value="1">
                      <label class="form-check-label" for="send_{{ key }}"></label>
                    </div>
                  </td>
                  <td><span class="text-muted">{{ key }}</span><br><strong>{{ label }}</strong></td>
                  <td>
                    <input class="form-control"
                      type="{{ 'password' if key=='pass' else ('number' if key in ['uport','soil','pump_ms','init_ms','dsw_ms','sleep_s'] else 'text') }}"
                      name="{{ key }}" value="{{ leftVal }}">
                  </td>
                  <td><input class="form-control readonly" type="text" value="{{ rightVal }}" readonly></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>

</html>