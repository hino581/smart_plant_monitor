<!-- templates/provisioning.html -->
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>プロビジョニング | 植物モニター</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      padding-top: 70px;
    }

    .table thead th {
      white-space: nowrap;
    }

    .form-check-input {
      transform: scale(1.05);
    }

    .readonly {
      background-color: var(--bs-tertiary-bg);
    }

    .w-ctl {
      width: 120px;
    }

    .w-key {
      width: 180px;
    }
  </style>
</head>

<body>
  {% include 'partials/_header.html' %}
  <div class="container">
    <div class="d-flex align-items-center mb-3">
      <h1 class="me-3 mb-0">🛠 プロビジョニング</h1>
      <span class="text-muted">最終受信：{{ device.last_report_time or "-" }}</span>
    </div>

    <!-- デバイス選択 -->
    <div class="card mb-3">
      <div class="card-body">
        <form class="row gy-2 gx-2 align-items-center" method="get" action="/provisioning">
          <div class="col-auto"><label class="col-form-label">対象デバイス（最新順）</label></div>
          <div class="col-auto">
            <select class="form-select" name="mac" onchange="this.form.submit()">
              {% set current_mac = device.mac or '-' %}
              <option value="">（最新を自動選択）</option>
              {% for d in devices %}
              {% set mac_str = d.mac or '-' %}
              <option value="{{ mac_str }}" {% if mac_str==current_mac %}selected{% endif %}>
                {{ mac_str }}（最終: {{ d.last_report_time or '-' }}）
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto text-muted">
            SoftAP：<code>{{ device.ap_ssid or '-' }}</code> / IP：<code>{{ device.ap_ip or '-' }}</code>
          </div>
        </form>
      </div>
    </div>

    <!-- 右にしかない項目（テーブル下に記載） -->
    <hr class="my-4">
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <label class="form-label">MAC/IP（識別）</label>
        <input class="form-control readonly" type="text" value="{{ device.mac or '-' }}" readonly>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">受信時刻</label>
        <input class="form-control readonly" type="text" value="{{ device.last_report_time or '-' }}" readonly>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">ap_ssid</label>
        <input class="form-control readonly" type="text" value="{{ device.ap_ssid or '-' }}" readonly>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">ap_ip</label>
        <input class="form-control readonly" type="text" value="{{ device.ap_ip or '-' }}" readonly>
      </div>
    </div>
    <hr class="my-4">

    <!-- 比較テーブル（左＝保存する値入力／右＝受信値readonly） -->
    <div class="card shadow-sm">
      <div class="card-header">
        <strong>設定値／受信値</strong>
      </div>
      <div class="card-body">
        <form method="post" action="/provisioning/save-selected">
          <!-- 送信先 ap_ip 表示（保存には使わないが参照のため残す） -->
          <input type="hidden" name="ap_ip" value="{{ device.ap_ip or '' }}" readonly>

          {% set rows = [
          ("ssid", "WiFi SSID", desired.get("ssid",""), device.ssid or "-"),
          ("pass", "WiFi PASS", desired.get("pass",""), device.pass if device.pass is defined else "-"),
          ("uaddr", "UDP Addr", desired.get("uaddr",""), device.uaddr or "-"),
          ("uport", "UDP Port", desired.get("uport",""), device.uport or "-"),
          ("soil", "Soil", desired.get("soil",""), device.soil or "-"),
          ("pump_ms", "Pump ms", desired.get("pump_ms",""),device.pump_ms or "-"),
          ("init_ms", "Init ms", desired.get("init_ms",""),device.init_ms or "-"),
          ("dsw_ms", "DS Wait ms", desired.get("dsw_ms",""), device.dsw_ms or "-"),
          ("sleep_s", "Sleep s", desired.get("sleep_s",""),device.sleep_s or "-"),
          ] %}

          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th class="w-ctl">保存</th>
                  <th class="w-key">キー</th>
                  <th>設定値</th>
                  <th>受信値</th>
                </tr>
              </thead>
              <tbody>
                {% for key, label, leftVal, rightVal in rows %}
                <tr>
                  <td>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="send_{{ key }}" id="send_{{ key }}"
                        value="1">
                      <label class="form-check-label" for="send_{{ key }}"></label>
                    </div>
                  </td>
                  <td><span class="text-muted">{{ key }}</span><br><strong>{{ label }}</strong></td>
                  <td>
                    <input class="form-control"
                      type="{{ 'password' if key=='pass' else ('number' if key in ['uport','soil','pump_ms','init_ms','dsw_ms','sleep_s'] else 'text') }}"
                      name="{{ key }}" value="{{ leftVal }}">
                  </td>
                  <td><input class="form-control readonly" type="text" value="{{ rightVal }}" readonly></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">チェックした項目を保存</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>

</html>