<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>植物モニター</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            padding-top: 70px;
        }

        .chart-card {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        #charts {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sensor-value {
            font-size: 0.9rem;
            color: var(--bs-secondary-color);
            margin-bottom: 5px;
        }

        .sensor-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        #status {
            font-size: 1rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .dark-mode body {
            background-color: #212529;
            color: #f8f9fa;
        }
    </style>
</head>

<body>
    <!-- ヘッダー ナビバー -->
    {% include 'partials/_header.html' %}

    <!-- メイン表示 -->
    <div class="container">
        <h1 class="mb-2">🌱 植物モニター</h1>

        <div id="status" class="text-muted">📶 データ未取得</div>
        <div id="alert" class="alert alert-danger d-none">
            ⚠ データの取得に失敗しました。
        </div>

        <div id="charts" class="mb-4"></div>
    </div>

    <script>
        const maxPoints = 100;
        const charts = {};
        const latestValues = {};
        let latestTimestamp = "";

        const sensorLabels = {
            Temp: "温度（°C）",
            Hum: "湿度（%）",
            Pres: "気圧（hPa）",
            Light: "明るさ",
            Soil: "土壌水分",
            Bus: "バス電圧（V）",
            Current: "電流（mA）",
            Power: "電力（mW）"
        };
        const sensorColors = {
            Temp: "#e74c3c",      
            Hum: "#3498db",       
            Pres: "#7f8c8d",      
            Light: "#f1c40f",     
            Soil: "#27ae60",      
            Bus: "#9b59b6",       
            Current: "#e67e22",   
            Power: "#8e6e53"      
        };

        async function fetchAllData() {
            try {
                const res = await fetch("/all-data");
                if (!res.ok) throw new Error("通信失敗");

                const rows = await res.json();
                if (!Array.isArray(rows) || rows.length === 0) return;

                document.getElementById("alert").classList.add("d-none");

                latestTimestamp = new Date(rows[rows.length - 1].timestamp);
                document.getElementById("status").textContent = `📅 最終更新: ${latestTimestamp.toLocaleString()}`;

                const keys = Object.keys(rows[0]).filter(k => k !== "timestamp");
                const timeList = rows.map(row => new Date(row.timestamp));
                const datasets = {};
                keys.forEach(k => datasets[k] = rows.map(row => parseFloat(row[k])));

                keys.forEach(key => {
                    latestValues[key] = datasets[key][datasets[key].length - 1];

                    if (!charts[key]) {
                        const card = document.createElement("div");
                        card.className = "card chart-card shadow-sm";
                        const title = sensorLabels[key] || key;

                        card.innerHTML = `
      <div class="card-body p-2">
        <div class="sensor-title">${title}</div>
        <div class="sensor-value" id="value-${key}">最新値: --</div>
        <div id="chart-${key}" style="height: 200px;"></div>
      </div>
    `;
                        document.getElementById("charts").appendChild(card);
                        const color = sensorColors[key] || "#333";

                        Plotly.newPlot(`chart-${key}`, [{
                            x: timeList,
                            y: datasets[key],
                            mode: "lines+markers",
                            line: { shape: "spline", color: color },
                            marker: { color: color }
                        }], {
                            margin: { t: 10, b: 30, l: 30, r: 10 },
                            xaxis: { showgrid: false, tickfont: { size: 10 } },
                            yaxis: { rangemode: "tozero", tickfont: { size: 10 } }
                        }, { responsive: true });

                        charts[key] = true;
                    } else {
                        Plotly.update(`chart-${key}`, {
                            x: [timeList],
                            y: [datasets[key]]
                        });
                    }

                    const valueEl = document.getElementById(`value-${key}`);
                    if (valueEl) valueEl.textContent = `最新値: ${latestValues[key].toFixed(2)}`;
                });

            } catch (err) {
                console.error("データ取得失敗:", err);
                document.getElementById("alert").classList.remove("d-none");
            }
        }

        fetchAllData();
        setInterval(fetchAllData, 10000);

        document.getElementById("darkModeSwitch").addEventListener("change", function () {
            if (this.checked) {
                document.documentElement.setAttribute("data-bs-theme", "dark");
            } else {
                document.documentElement.setAttribute("data-bs-theme", "light");
            }
        });
    </script>

</body>

</html>
